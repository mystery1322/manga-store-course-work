<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Каталог — Лавка Мечтаний</title>
  
  <!-- Подключение иконки сайта -->
  <link rel="icon" type="image/png" href="images/fav.png">

  <!-- Главный стиль сайта -->
  <link href="style.css" rel="stylesheet">
  <!-- Специфичные стили для страницы каталога -->
  <link href="catalog.css" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <!-- Скрипт (defer чтобы DOM был готов) -->
  <script src="products-data.js" defer></script>
  <script src="scripts.js" defer></script>
  <script src="catalog.js" defer></script>

</head>

<body>
  <!-- header: как в других страницах -->
  <header id="top" class="site-header">
    <div class="aboba logo-block">
      <a href="index.html" class="logo-link">
        <img src="images/logo.png" alt="Логотип" width="79" class="site-logo">
        <h1 class="site-title">Лавка Мечтаний✨</h1>
      </a>
    </div>

    <button id="burgerBtn" class="burger icon-btn" aria-label="Открыть меню" aria-expanded="false" aria-controls="mainNav">
      ☰
    </button>

    <!-- центр с гифками (декоративно) -->
    <div class="header-center" aria-hidden="true">
      <img src="images/bts-cats-cat.gif" alt="" class="header-gif">
      <img src="images/bts-cats-cat.gif" alt="" class="header-gif">
      <img src="images/bts-cats-cat.gif" alt="" class="header-gif">
      <img src="images/bts-cats-cat.gif" alt="" class="header-gif">
      <img src="images/bts-cats-cat.gif" alt="" class="header-gif">
      <img src="images/bts-cats-cat.gif" alt="" class="header-gif">
      <img src="images/bts-cats-cat.gif" alt="" class="header-gif">
      <img src="images/bts-cats-cat.gif" alt="" class="header-gif">
    </div>

    <nav class="main-nav" aria-label="Главное меню">
      <ul>
        <li><a href="index.html"><span class="no-wrap">✨О нас</span></a></li>
        <li><a href="catalog.html" class="active">Каталог</a></li>
        <li><a href="cart.html">Корзина <span id="cart-badge" class="cart-badge" aria-hidden="true" style="font-family:'Roboto', sans-serif;">0</span></a></li>
        <li><a href="profile.html">Мой профиль</a></li>
      </ul>
    </nav>
  </header>

  <div class="catalog-wrapper" role="main">
    <!-- MAIN: собственно каталог, занимает всё доступное пространство слева -->
    <main class="catalog-main" aria-label="Каталог товаров">
      <section id="catalogGrid" class="product-grid" aria-live="polite">
        <!-- Здесь рендерятся карточки товаров скриптом -->
      </section>
    </main>

    <!-- RIGHT SIDEBAR: поиск + фильтры — фиксированная/прилипшая панель -->
    <aside class="catalog-filters" role="region" aria-label="Поиск и фильтры каталога">
      <div class="filter-group">
        <label for="search">Поиск</label>
        <input id="search" class="search-input" placeholder="Поиск по названию или автору" />
      </div>

      <div class="filter-group">
        <label for="genreFilter">Жанр</label>
        <select id="genreFilter" class="select">
          <option value="all">Все жанры</option>
          <option value="shonen">Сёнэн</option>
          <option value="seinen">Сэйнэн</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="sortBy">Сортировка</label>
        <select id="sortBy" class="select">
          <option value="default">По умолчанию</option>
          <option value="price-asc">Цена ↑</option>
          <option value="price-desc">Цена ↓</option>
          <option value="title-asc">Название A→Z</option>
        </select>
      </div>  

      <div class="filter-group">
        <button id="clearFilters" class="btn" style="width:100%;">Сбросить фильтры</button>
      </div>

      <div style="font-size:13px;color:#666;margin-bottom:38px;"></div>
    </aside>
  </div>

  <footer class="site-footer right" style="margin-top:200px;">
    <h2>Связь с нами</h2>
    <address>
      Телефон: <a href="tel:896742993722">896742993722</a><br>
      Почта: <a href="mailto:manga-shop@mail.ru">manga-shop@mail.ru</a><br>
      Разработчик: Ирицян Артур
    </address>
  </footer>

  <!-- Скрипт: рендер + фильтры (оставлен встроенным) -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const PROD = (window.PRODUCTS && Array.isArray(window.PRODUCTS)) ? window.PRODUCTS : [
      // fallback: можно оставить пару тестовых товаров
      {id: 'm1', title:'Манга Влюбленный паразит Том 1 и 2', author:'Koisuru kiseichuu', price:1199, img:'images/parasite1.png', genre:'seinen'}
    ];

    const CART_KEY = 'manga_cart_v1';

    function loadCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); } catch(e){ return []; } }
    function saveCart(cart){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); updateCartBadge(); }

    function updateCartBadge(){
      const el = document.getElementById('cart-badge');
      if(!el) return;
      const cart = loadCart();
      const count = cart.reduce((s,p)=>s+(p.qty||0),0);
      el.textContent = count;
      el.classList.toggle('hidden', count===0);
    }

    const grid = document.getElementById('catalogGrid');

    function renderProducts(list){
      grid.innerHTML = '';
      if(!list.length){ grid.innerHTML = '<p class="catalog-empty">Товары не найдены.</p>'; return; }
      list.forEach(p=>{
        const art = document.createElement('article');
        art.className = 'product-card';
        art.innerHTML = `
          <a href="product.html?id=${encodeURIComponent(p.id)}" class="product-link" style="text-decoration:none;color:inherit;display:block;">
            <img src="${p.img}" alt="${p.title}" class="product-img">
            <h3 class="product-title">${p.title}</h3>
            <p class="meta">Автор: ${p.author}</p>
          </a>
          <div class="product-footer">
            <p class="price">${Number(p.price).toFixed(2)} ₽</p>
            <button class="btn add-btn" data-id="${p.id}" aria-label="Добавить ${p.title} в корзину">Добавить</button>
          </div>
        `;
        grid.appendChild(art);
      });
    }

    function addToCart(productId, qty = 1) {
      const cart = loadCart();
      const prod = PROD.find(p => p.id === productId);
      const existing = cart.find(x => x.id === productId);
      if (existing) existing.qty = (existing.qty || 0) + Number(qty || 1);
      else {
        cart.push({
          id: productId,
          title: prod?.title || ('Товар ' + productId),
          price: prod?.price ?? 0,
          img: prod?.img || 'images/missing.png',
          author: prod?.author || '',
          qty: Number(qty || 1)
        });
      }
      saveCart(cart);
      if (window.showToast) showToast((prod?.title || 'Товар') + ' добавлен в корзину', 'success', 1800);
      else alert((prod?.title || 'Товар') + ' добавлен в корзину');
    }

    // делегирование кликов
    document.addEventListener('click', e=>{
      const btn = e.target.closest('.add-btn');
      if(!btn) return;
      addToCart(btn.dataset.id, 1);
    });

    // фильтры
    function filterAndRender(){
      const q = (document.getElementById('search')?.value || '').trim().toLowerCase();
      const genre = document.getElementById('genreFilter')?.value || 'all';
      const sort = document.getElementById('sortBy')?.value || 'default';
      let result = PROD.filter(p=>{
        const matchQ = q === '' || (p.title && p.title.toLowerCase().includes(q)) || (p.author && p.author.toLowerCase().includes(q));
        const matchGenre = genre === 'all' || p.genre === genre || (Array.isArray(p.genre) && p.genre.includes(genre));
        return matchQ && matchGenre;
      });
      if(sort==='price-asc') result.sort((a,b)=>a.price-b.price);
      else if(sort==='price-desc') result.sort((a,b)=>b.price-a.price);
      else if(sort==='title-asc') result.sort((a,b)=>a.title.localeCompare(b.title,'ru'));
      renderProducts(result);
    }

    // привязки
    document.getElementById('search')?.addEventListener('input', filterAndRender);
    document.getElementById('genreFilter')?.addEventListener('change', filterAndRender);
    document.getElementById('sortBy')?.addEventListener('change', filterAndRender);
    document.getElementById('clearFilters')?.addEventListener('click', ()=>{
      document.getElementById('search').value = '';
      document.getElementById('genreFilter').value = 'all';
      document.getElementById('sortBy').value = 'default';
      filterAndRender();
    });

    // init
    renderProducts(PROD);
    updateCartBadge();

    // sync badge
    window.addEventListener('storage', ev => { if(ev.key === CART_KEY) updateCartBadge(); });
  });
</script>
</body>
</html>
